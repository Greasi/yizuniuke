define("nowcoder/1.2.348/javascripts/site/discuss/discussPost",["../../lib/jquery","../../lib/underscore","../../core/base","../../util/limit","../../util/ke","../../lib/kindeditor","../../util/util","../../util/cookie","../../core/siteConfig","../../component/menu","../../util/dom","../../util/browser","../../core/component","../../util/event","../../component/select","../../component/popup","../../component/layer","../../util/dragdrop","../../component/input","../../action/discuss","../../util/ajax"],function(a){function b(){var a=this;o.copy(a,window,["draft","post","user"]),a.draft=a.draft.draftJs||{},a.globalInfo=n.clone(window.globalInfo),a.postTitle=m(".discuss-topic-title"),a.discussPost=(a.post.discussPost||{}).content||"",a.discussPostId=a.post.discussPost.id||0,a.isAdmin=a.user.isAdmin,a.typeIds=(window.typeIds||"").split(","),a.initEditor(),a.initEditorTop(),a.initTags()}function c(){var b=this;b.contentIpt=q.create("div.js-editor",{toolbarFixedTop:r.getNavHeight(),items:b.isAdmin?q.adminItems:null,placeholder:"输入描述，越详细越好哦",afterFocus:function(){window.isLogin||(b.contentIpt.blur(),a.async("../../component/loginDialog",function(a){a.show({register:w.popup.showReg,loginCb:function(){window.location.reload()},registerCb:function(){window.location.reload()}})}))},draftChange:function(a){window.isLogin&&v.saveDiscussDraft({body:{type:w.draftType.post,entityId:b.discussPostId,content:a,title:m.trim(b.titleIpt.val()),discussType:b.typeSelect.val()+1,tags:b.getTagIds().join(",")}})},height:320}),b.draft.content?b.contentIpt.html(b.draft.content):b.discussPost&&b.contentIpt.html(b.discussPost)}function d(){var a=this;a.typeSelect=u.transform(m("#jsTopicSelectedBox")),a.titleIpt=t.transform(m("#jsTopTitle"),{change:function(){b.call(this)},blur:function(){b.call(this)}});var b=function(){var a=this,b=m.trim(a.val());b.length>30?a.errorTips("最多输入30个字符"):a.none()}}function e(a){var b=this,c=m(a.currentTarget),d=b.getType(),e=m.trim(b.titleIpt.val()),f=m.trim(b.contentIpt.text());if(!f)return s.alert("帖子内容不能为空"),void 0;if(!e)return b.titleIpt.errorTips("帖子标题不能为空"),void 0;if(e.length>30)return b.titleIpt.errorTips("最多输入30个字符"),void 0;if("4"===d&&!b.isAdmin)return s.alert("你不是管理员，你不能在站内公告板块发帖"),void 0;if(!p.mark(c)){var g=b.showMask();v.createPost({body:{title:e,content:m.trim(b.contentIpt.html()),type:d,tags:b.getTagIds().join(",")},call:function(a){g.close(),b.contentIpt.html("");var c=s.tips("发布成功",2e3);c.listen("close",function(){window.location.href=a.id?"/discuss/"+a.id:"/discuss"})},error:function(a){g.close(),s.alert(a.msg,function(){-1===a.code?window.location.href="/discuss":p.pause(c)})}})}}function f(){var a=this,b=a.post.edit;v.saveDiscussDraft({body:{entityId:a.discussPostId,content:""}}),window.setTimeout(function(){window.location.href=b?"/discuss/"+a.post.discussPost.id:"/discuss"},500)}function g(a){var b=this,c=m(a.currentTarget),d=b.discussPostId,e=m.trim(b.titleIpt.val()),f=m.trim(b.contentIpt.text()),g=b.getType();if(!f)return s.alert("帖子内容不能为空"),void 0;if(!e)return b.titleIpt.errorTips("帖子标题不能为空"),void 0;if("4"===g&&!b.isAdmin)return s.alert("你不是管理员，你不能在站内公告板块发帖"),void 0;if(e.length>30)return b.titleIpt.errorTips("最多输入30个字符"),void 0;if(!p.mark(c)){var h=b.showMask();v.editPost({body:{title:e,content:m.trim(b.contentIpt.html()),id:d,type:g,tags:b.getTagIds().join(",")},call:function(){h.close();var a=s.tips("编辑成功",2e3);a.listen("close",function(){window.location.href="/discuss/"+d})},error:function(a){h.close(),s.alert(a.msg,function(){-1===a.code?window.location.href="/discuss":p.pause(c)})}})}}function h(a){var b=m(a.currentTarget);b[b.hasClass("selected")?"removeClass":"addClass"]("selected")}function i(){var a=this,b=a.draft.tags||a.post.tags||"";n.forEach(b.split(","),function(a){a&&m("div.tags-box .tag-label[data-id="+a+"]").addClass("selected")})}function j(){var a=this,b=+a.typeSelect.val()||0;return(a.typeIds[b]||1)+""}function k(){var a=m("div.tags-box .tag-label.selected"),b=n.map(a,function(a){return m(a).attr("data-id")});return b||[]}function l(){var a=new s({hasNoTitle:!0,hasNoMove:!0,hasNoFooter:!0,content:['<div class="confirm-content">','<div class="poptip-word">','<span class="warning-word">正在提交中...</span>',"</div>","</div>"].join(""),width:500,clickToHide:!0});return a}var m=a("../../lib/jquery"),n=a("../../lib/underscore"),o=a("../../core/base"),p=a("../../util/limit"),q=a("../../util/ke"),r=a("../../util/dom"),s=a("../../component/popup"),t=a("../../component/input"),u=a("../../component/select"),v=a("../../action/discuss"),w=a("../../core/siteConfig");o.ready({initialize:b,binds:{"click a#jsPublish":e,"click a#jsCancel":f,"click a#jsEdit":g},events:{"click div.tags-box .tag-label":h},initEditor:c,initEditorTop:d,initTags:i,getType:j,getTagIds:k,showMask:l})});
