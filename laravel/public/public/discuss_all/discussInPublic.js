define("nowcoder/1.2.348/javascripts/site/discuss/discussInPublic",["../../lib/jquery","../../lib/underscore","../../core/base","../../util/limit","../../core/siteConfig","../../util/ke","../../lib/kindeditor","../../util/util","../../util/cookie","../../component/menu","../../util/dom","../../util/browser","../../core/component","../../util/event","../../component/select","../../component/popup","../../component/layer","../../util/dragdrop","../../action/discuss","../../util/ajax","../../action/contest","../../kit/commentList","../../component/subComment","../../kit/ncShare","../../util/littleAction","../../action/note"],function(a){function b(){var a=this;o.copy(a,window,["post","comment"]),a.comment.draft=(a.comment.draft||{}).content||"",a.globalInfo=n.clone(window.globalInfo);var b=m("#commentList"),c=b.closest("div.module-box");a.commentList=new x({entityId:a.post.id,entityType:a.post.entityType,isAdmin:a.post.isAdmin,currentUid:a.globalInfo.ownerId,listContainer:c,listEl:b,pageEl:m("div.pagination ul"),currentCmts:a.comment.all,totalCount:a.comment.count,pageSize:a.comment.pageSize,currentPage:a.comment.curPage,autoOpenSubCmt:!0,delCb:function(a){var b=c.find("div.module-head h1");b.html(a+"条回帖")},createCb:function(a){var b=c.find("div.module-head h1");b.html(a+"条回帖")}}),a.initEditor(),a.initShare(),a.initHref(),z.follow({followCls:"click-follow",unfollowCls:"click-unfollow",entityId:a.post.id,entityType:q.type.post}),window.setTimeout(function(){a.commentList.scrollToCmt(s.getParam("toCommentId"))},1e3)}function c(){var a=m("div.post-topic-des a");window.setTimeout(function(){n.forEach(a,function(a){var b=a.href;a=m(a),b=b||a.attr("href"),b&&-1!==b.indexOf("http")&&-1===b.indexOf("nowcoder.com")&&a.attr("target","_blank")})},250)}function d(a){var b=this,c=m(a.currentTarget),d=c.attr("data-action");"unlike"!==d&&"like"!==d||p.mark(c)||w["unlike"===d?"unlike":"like"]({body:{id:b.post.id,type:b.post.entityType},call:function(){var a=window.parseInt(c.attr("data-count"),10),b=m(".post-like");"like"===d?(a++,n.each(b,function(b){b=m(b);var c=b.text();c=c.replace("赞","已赞").replace(/\d+/,a),b.html(c),b.attr("data-action","unlike"),b.attr("data-count",a)})):(a--,n.each(b,function(b){b=m(b);var c=b.text();c=c.replace("已赞","赞").replace(/\d+/,a),b.html(c),b.attr("data-action","like"),b.attr("data-count",a)}))},error:function(a){u.alert(a.msg)},always:function(){p.pause(c)}})}function e(){if(window.isLogin){var a=m("div.editor-box").closest("div.module-box");t.scrollToEl({el:a,animation:!0,ext:-m("div.nowcoder-header").height()-10}),t.highLight({el:a})}}function f(a){var b=this,c=m(a.currentTarget);p.mark(c)||u.confirm("删除后这篇帖子将无法恢复，是否确定删除？",function(){v.deletePost({body:{id:b.post.id},call:function(){u.tips("操作成功",function(){window.location.href="/discuss"})},error:function(a){u.alert(a.msg)},always:function(){p.pause(c)}})},function(){p.clear(c)})}function g(a){var b=this,c=m(a.currentTarget),d=c.attr("data-action");if(!("top"!==d&&"untop"!==d||p.mark(c))){var e=c.attr("data-all");v[d]({body:{postId:b.post.id,isTopAll:"0"!==e},call:function(){c.attr("data-action","top"==d?"untop":"top"),"0"!==e?c.html("全站置顶"==c.text()?"取消全站置顶":"全站置顶"):c.html("置顶"==c.text()?"取消置顶":"置顶")},error:function(a){u.alert(a.msg)},always:function(){p.pause(c)}})}}function h(a){var b=this,c=m(a.currentTarget),d=c.attr("data-action");"gild"!==d&&"ungild"!==d||p.mark(c)||v[d]({body:{postId:b.post.id},call:function(){c.attr("data-action","gild"==d?"ungild":"gild"),c.html("加精"==c.text()?"取消加精":"加精")},error:function(a){u.alert(a.msg)},always:function(){p.pause(c)}})}function i(){var b=this;if(m("div.js-editor").length>0){var c=function(){window.isLogin||(b.commentIpt.blur(),a.async("../../component/loginDialog",function(a){a.show({register:q.popup.showReg,loginCb:function(){window.location.reload()},registerCb:function(){window.location.reload()}})}))};b.commentIpt=r.create("div.js-editor",{toolbarFixedTop:t.getNavHeight(),placeholder:"在这里畅所欲言你的看法吧！",disabled:!window.isLogin,afterFocus:c,clickMask:c,draftChange:function(a){window.isLogin&&v.saveDiscussDraft({body:{entityId:b.post.id,content:a,type:q.draftType.answerPost}})},height:180}),b.comment.draft&&b.commentIpt.html(b.comment.draft)}}function j(a){var b=this,c=m(a.currentTarget);p.mark(c)||b.commentList.createCmt({text:m.trim(b.commentIpt.text()),content:m.trim(b.commentIpt.html()),call:function(){b.commentIpt.html("")},error:function(){},always:function(){p.pause(c)}})}function k(b){b.stopPropagation(),b.preventDefault();var c=m(b.currentTarget),d=c.attr("src");d&&a.async("../../component/popupImage",function(a){new a({items:[d]})})}function l(){var a=m("h1.discuss-title").text(),b=m("div.post-topic-des");try{b=m(b[0].cloneNode(!0)),b.find("script").remove()}catch(c){}var d="「"+a+"」 "+b.text().replace(/\r|\n/g,"");d=d.replace(/\s+/g," ");var e=d.length>100?d.substring(0,100)+"...":d;y.bind({el:m("li.oprt-item-share a.share-link"),title:m("h1.discuss-title").text(),desc:e,link:window.location.href})}var m=a("../../lib/jquery"),n=a("../../lib/underscore"),o=a("../../core/base"),p=a("../../util/limit"),q=a("../../core/siteConfig"),r=a("../../util/ke"),s=a("../../util/util"),t=a("../../util/dom"),u=a("../../component/popup"),v=a("../../action/discuss"),w=a("../../action/contest"),x=a("../../kit/commentList"),y=a("../../kit/ncShare"),z=a("../../util/littleAction");o.ready({initialize:b,events:{"click .post-like":d,"click .js-post-replay":e,"click .js-post-del":f,"click .post-top":g,"click .post-gild":h,"click div.post-topic-des img":k,"click div.answer-brief img":k},binds:{"click #jsPubPoint":j},initHref:c,initEditor:i,initShare:l})});
