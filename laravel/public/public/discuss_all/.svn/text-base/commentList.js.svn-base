define("nowcoder/1.2.348/javascripts/kit/commentList",["../lib/jquery","../lib/underscore","../core/base","../util/util","../util/cookie","../util/limit","../util/dom","../util/browser","../action/contest","../util/ajax","../core/siteConfig","../component/popup","../core/component","../util/event","../component/layer","../util/dragdrop","../component/subComment"],function(a,b,c){function d(a){var b=this;if(b.rawConfig=a,b.listContainer=r(a.listContainer),b.scrollContainer=a.scrollContainer?r(a.scrollContainer):b.listContainer,b.listEl=r(a.listEl),b.pageEl=r(a.pageEl),b.blankEl=b.listContainer.find("#commentNone"),b.pageSize=a.pageSize||20,b.totalCount=a.totalCount,b.currentPage=a.currentPage||1,b.totalPageCount=Math.floor((b.totalCount-1)/b.pageSize)+1,b.autoOpenSubCmt=!!a.autoOpenSubCmt,b.isAdmin=!!a.isAdmin,b.currentUid=a.currentUid,b.listEl.addClass("answer-list discuss-topic-answers"),b.cmtMap={},b.cmtItemMap={},b.cmtArray=(a.currentCmts||[]).slice(0),b.initCmtCache(a.currentCmts),b.initEvent(),0===b.blankEl.length&&(b.blankEl=r('<div id="commentNone" class="blank-box" style="display:none;"><div class="blank-img"><img src="http://static.nowcoder.com/images/sofa.png"></div><p>帖子还没人回复，快来抢沙发！</p></div>'),b.listEl.after(b.blankEl)),0===b.pageEl.length){var c=b.listContainer.find("pagination");c=0===c.length?r('<div class="pagination"><ul></ul></div>'):c,b.listEl.after(c);var d=c.find("ul");d=0===d.length?r("<ul></ul>"):d,c.append(d),b.pageEl=d,c.hide()}window.setTimeout(function(){b.expandSubCmt()},250)}function e(){var a=this;t.bind({},{"click div.pagination li a":i,"click .js-cmt-reply":j,"click .js-cmt-like":k,"click a.click-del":l},a)}function f(a){var b=this;a=a?u.isArray(a)?a:[a]:null,a&&s.forEach(a,function(a){a&&(b.cmtMap[a.id]=a)})}function g(a,b){var c=this;c.getPageCmt({page:a-1,call:function(d){c.currentPage=a,c.renderPageCmt(d),c.scrollToCmtTop(!0),window.setTimeout(function(){c.expandSubCmt()},250),w.fixPagination({el:c.pageEl,currentPage:a,totalPage:c.totalPageCount});var e=!d||0===d.length;c.blankEl[e?"show":"hide"](),c.listEl[e?"hide":"show"](),c.pageEl.parent()[c.totalPageCount<=1?"hide":"show"](),b&&b()},error:function(){b&&b()}})}function h(a){var b=this,c="",d=['<li class="answer-list-item clearfix" data-id="#{cmtId}">','<div data-cmt-id="#{cmtId}" class="answer-content clearfix">','<a class="answer-head" href="/profile/#{authorId}">','<img alt="#{name}头像" src="#{avatar}">',"</a>",'<div class="answer-detail">','<p><a title="#{name}" href="/profile/#{authorId}" class="answer-name level-color-#{honorLevel}">#{name}</a><span class="post-floor">#{floor}#</span></p>','<div class="answer-brief">#{content}</div>','<div class="answer-legend">','<span class="answer-time">发表于 #{createTime}</span>','<a href="javascript:void(0);" class="js-cmt-reply">回复(#{commentCnt})</a>','<a href="javascript:void(0);" class="js-cmt-like" data-action="#{cmtLikeAction}">#{cmtLikeTxt}(#{cmtLike})</a>',"#{cmtDel}","</div>","</div>","</div>","</li>"].join("");cmtArray=a.slice(0),s.each(a,function(a,e){var f=new Date(a.createTime),g=new Date,h=f.getFullYear()===g.getFullYear()&&f.getMonth()===g.getMonth()&&f.getDate()===g.getDate();c+=t.execTpl(d,{cmtId:a.id,avatar:a.headImg||B.avatar.small,name:a.authorName,authorId:a.authorId,honorLevel:a.honorLevel,content:a.content,createTime:h?"今天 "+u.formDate(f,"HH:mm:ss"):u.formDate(f,"yyyy-MM-dd HH:mm:ss"),commentCnt:a.commentCnt||0,cmtLikeAction:a.isLiked?"unlike":"like",cmtLikeTxt:a.isLiked?"已赞":"赞",cmtLike:a.likes||0,cmtDel:a.authorId==b.currentUid||b.isAdmin?'<a href="javascript:void(0);" class="click-del" >删除</a>':"",floor:e+1+(b.currentPage-1)*b.pageSize})}),b.listEl.html(c)}function i(a){a.preventDefault();var b=this,c=r(a.currentTarget);c.parent();var d=window.parseInt(c.attr("data-page"),10);c.blur(),!d||1>d||d===b.currentPage||v.mark(c)||b.jump2page(d,function(){v.clear(c)})}function j(a){var b=this,c=r(a.currentTarget),d=c.closest("li.answer-list-item"),e=d.attr("data-id"),f=b.cmtMap[e],g=b.rawConfig;if(d&&e&&f&&!v.mark(c)){var h=b.cmtItemMap;h[e]||(h[e]={item:new z({renderTo:d.find("div.answer-detail"),comment:f,inputWidth:g.subCmtInputWidth||538,listeners:{addCmt:function(){f.commentCnt++,c.html("回复("+f.commentCnt+")")},delCmt:function(){f.commentCnt--,c.html("回复("+f.commentCnt+")")}},animation:!1,firstCount:a.firstCount,isAdmin:b.isAdmin}),showed:!1});var i=h[e];if(i.showed){var j=function(){i.item.destroy(),h[e]=null,v.pause(c)};try{i.item.getEl().slideUp(200,j)}catch(k){j()}}else i.item.show(),i.showed=!0,v.pause(c)}}function k(a){var b=this,c=r(a.currentTarget),d=c.closest("li.answer-list-item"),e=d.attr("data-id"),f=b.cmtMap[e];if(d&&e&&f){var g=c.attr("data-action");"unlike"!==g&&"like"!==g||v.mark(c)||x["unlike"===g?"unlike":"like"]({body:{id:f.id,type:B.type.comment},call:function(){"like"===g?(f.likes++,c.html("已赞("+f.likes+")"),c.attr("data-action","unlike")):(f.likes--,c.html("赞("+f.likes+")"),c.attr("data-action","like"))},error:function(a){y.alert(a.msg)},always:function(){v.pause(c)}})}}function l(a){var b=this,c=r(a.currentTarget),d=c.parents("div.answer-content"),e=d.attr("data-cmt-id"),f=b.cmtMap[e],g=b.rawConfig;if(d&&e&&f&&!v.mark(c)){var e=f.id;y.confirm("确定删除评论？",function(){x.delComment({body:{id:e},call:function(){var a=c.closest("li.answer-list-item");delete b.cmtMap[e],delete b.cmtItemMap[e];for(var d=0,f=b.cmtArray.length;f>d;d++)if(b.cmtArray[d].id===e){b.cmtArray.splice(d,1);break}b.totalCount--,b.totalPageCount=Math.floor((b.totalCount-1)/b.pageSize)+1;var h=b.currentPage;h=h>b.totalPageCount?b.totalPageCount:h,b.currentPage=h,a.slideUp(150,function(){a.remove(),y.tips("操作成功"),b.scrollToCmtTop(!0),b.jump2page(h)}),g.delCb&&g.delCb(b.totalCount)},error:function(a){y.alert(a.msg||B.tips.ajaxError)},always:function(){v.pause(c)}})},function(){v.clear(c)})}}function m(){var a=this,b=this.listEl.find("li.answer-list-item"),c=a.cmtMap;if(a.autoOpenSubCmt&&0!==b.length){var d=a.cmtItemMap;s.forEach(d,function(a,b){a.item.destroy(),delete d[b]});for(var e=0,f=b.length;f>e;e++){var g=r(b[e]),h=g.attr("data-id");if(0!==c[h].commentCnt){var i=g.find("a.js-cmt-reply");j.call(a,{currentTarget:i,firstCount:5})}}}}function n(a){var b=this;w.scrollToEl({el:b.scrollContainer,animation:!a,ext:-1*w.getNavHeight()-10})}function o(a){if(a){a+="";var b=this,c=b.listEl.find("li.answer-list-item");s.every(c,function(b){b=r(b);var c=b.attr("data-id");return c===a?(w.scrollToEl({el:b,animation:!1,ext:-1*w.getNavHeight()-10}),w.highLight({el:b}),!1):!0})}}function p(a){var b=this,c=b.rawConfig.entityId,d=b.rawConfig.entityType,e=a.page,f=a.call,g=a.error;x.getCommentByPage({params:{pageSize:b.pageSize,page:e+1,order:1,entityId:c,entityType:d},call:function(a){var c=a.comments;c&&c.length>0&&b.initCmtCache(c),f(c||[])},error:function(a){y.alert(a.msg),g&&g()}})}function q(a){function b(){x.comment({body:{entityType:c.rawConfig.entityType,entityId:c.rawConfig.entityId,commentContent:e,toUserId:0,toCommentId:0},call:function(){c.totalCount++,c.totalPageCount=Math.floor((c.totalCount-1)/c.pageSize)+1,c.currentPage=c.totalPageCount,c.scrollToCmtTop(!0),y.tips("你的回复已提交"),c.jump2page(c.currentPage),a.call&&a.call(),a.always&&a.always(),c.rawConfig.createCb&&c.rawConfig.createCb(c.totalCount)},error:function(b){y.alert(b.msg),a.error&&a.error(),a.always&&a.always()}})}var c=this,d=a.text,e=a.content;return d?(d.length<5?y.confirm("灌水的话可能会被管理员删除的，确定现在提交吗",function(){b()}):b(),void 0):(y.alert("内容不能为空"),a.error&&a.error(),a.always&&a.always(),void 0)}var r=a("../lib/jquery"),s=a("../lib/underscore"),t=a("../core/base"),u=a("../util/util"),v=a("../util/limit"),w=a("../util/dom"),x=a("../action/contest"),y=a("../component/popup"),z=a("../component/subComment"),A=c.exports=t.createClass("kit.CommentList"),B=a("../core/siteConfig");s.extend(A.prototype,{initialize:d,initEvent:e,initCmtCache:f,jump2page:g,renderPageCmt:h,expandSubCmt:m,scrollToCmtTop:n,scrollToCmt:o,getPageCmt:p,createCmt:q})});
